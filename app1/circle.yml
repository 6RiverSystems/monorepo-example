machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  node:
    version: 10.4.1
  services:
    - docker
  environment:
    DATABASE_URL: postgres://ubuntu:@127.0.0.1:5432/circle_test
    MOCHA_OPTS: --reporter mocha-junit-reporter --reporter-options mochaFile=$CIRCLE_TEST_REPORTS/mocha/junit.xml

dependencies:
  pre:
    - git clone --depth 1 git@github.com:6RiverSystems/infrastructure.git ~/infrastructure
    - ~/infrastructure/ci_scripts/setupNpm.sh

test:
  pre:
    - mkdir -p $CIRCLE_TEST_REPORTS/mocha
  override:
    - npm test

deployment:
  docker-publish:
    branch: [master,develop]
    commands:
      - make -f ~/infrastructure/ci_scripts/release.makefile docker_publish
