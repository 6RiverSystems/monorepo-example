version: 2
jobs:
  install:
    docker:
      - image: circleci/node:10.15.3
        environment:
          DATABASE_URL: postgres://root:@127.0.0.1:5432/circle_test
          RUSH_ABSOLUTE_SYMLINKS: "true"
    steps:
      - checkout
      - restore_cache:
          keys:
            - rush-global-v1-{{ checksum "common/config/rush/pnpm-lock.yaml" }}
            - rush-global-v1-
            - rush-global-v1
      - restore_cache:
          keys:
            - rush-local-v1-{{ checksum "common/config/rush/pnpm-lock.yaml" }}
            - rush-local-v1-
            - rush-local-v1
      - run:
          name: Set Up Environment
          command: |
            mkdir ci_scripts
            curl -H "Authorization: token $GITHUB_TOKEN" -H "Accept:application/vnd.github.v3.raw"  https://api.github.com/repos/6RiverSystems/ci_scripts/contents/ci_tool.sh > ci_scripts/ci_tool.sh
            chmod +x ci_scripts/ci_tool.sh
            ci_scripts/ci_tool.sh --setup_npm
      - run:
          name: Check Dependencies
          command: |
            repo-tools/scripts/run-rush-collect-logs.sh rush-logs node common/scripts/install-run-rush.js check
      - run:
          name: Install Dependencies
          command: |
            repo-tools/scripts/run-rush-collect-logs.sh rush-logs node common/scripts/install-run-rush.js install --no-link
      - run:
          name: Setup new version
          command: |
            ./repo-tools/scripts/version.sh
      - save_cache:
          key: rush-global-v1-{{ checksum "common/config/rush/pnpm-lock.yaml" }}
          paths:
            - "/home/circleci/.rush"
      - store_artifacts:
          path: rush-logs
      - persist_to_workspace:
          root: ./
          paths:
            - .

  save_local_cache:
    docker:
      - image: circleci/node:10.15.3
        environment:
          DATABASE_URL: postgres://root:@127.0.0.1:5432/circle_test
          RUSH_ABSOLUTE_SYMLINKS: "true"
    steps:
      - attach_workspace:
          at: ./
      - save_cache:
          key: rush-local-v1-{{ checksum "common/config/rush/pnpm-lock.yaml" }}
          paths:
            - "./common/temp"

  build:
    docker:
      - image: circleci/node:10.15.3
        environment:
          DATABASE_URL: postgres://root:@127.0.0.1:5432/circle_test
          RUSH_ABSOLUTE_SYMLINKS: "true"
    steps:
      - attach_workspace:
          at: ./
      - restore_cache:
          keys:
            - rush-global-v1-{{ checksum "common/config/rush/pnpm-lock.yaml" }}
      - run:
          name: rush link
          command: |
            repo-tools/scripts/run-rush-collect-logs.sh rush-logs node common/scripts/install-run-rush.js link --force
      - run:
          name: Build
          command: |
            repo-tools/scripts/run-rush-collect-logs.sh rush-logs node common/scripts/install-run-rush.js rebuild
      - store_artifacts:
          path: rush-logs
      - persist_to_workspace:
          root: ./
          paths:
            - .

  lint:
    docker:
      - image: circleci/node:10.15.3
        environment:
          DATABASE_URL: postgres://root:@127.0.0.1:5432/circle_test
          RUSH_ABSOLUTE_SYMLINKS: "true"
    steps:
      - attach_workspace:
          at: ./
      - restore_cache:
          keys:
            - rush-global-v1-{{ checksum "common/config/rush/pnpm-lock.yaml" }}
      - run:
          name: Lint
          command: |
            repo-tools/scripts/run-rush-collect-logs.sh rush-logs node common/scripts/install-run-rush.js lint
      - store_artifacts:
          path: rush-logs
      - store_artifacts:
          path: /home/circleci/project/reports/junit/
      - store_test_results:
          path: /home/circleci/project/reports/junit/

  test:
    docker:
      - image: circleci/node:10.15.3
        environment:
          DATABASE_URL: postgres://root:@127.0.0.1:5432/circle_test
          RUSH_ABSOLUTE_SYMLINKS: "true"
      - image: postgres:9
        environment:
          POSTGRES_USER: root
          POSTGRES_DB: circle_test
      - image: singularities/pubsub-emulator
        environment:
          PUBSUB_PROJECT_ID: test
          PUBSUB_LISTEN_ADDRESS: 0.0.0.0:8802
      - image: singularities/datastore-emulator
        environment:
          DATASTORE_PROJECT_ID: test
          DATASTORE_LISTEN_ADDRESS: 0.0.0.0:8803
    steps:
      - attach_workspace:
          at: ./
      - restore_cache:
          keys:
            - rush-global-v1-{{ checksum "common/config/rush/pnpm-lock.yaml" }}
      - run:
          name: Test
          command: |
            repo-tools/scripts/run-rush-collect-logs.sh rush-logs node common/scripts/install-run-rush.js test-ci
      - run:
          name: Coverage
          command: |
            repo-tools/scripts/run-rush-collect-logs.sh rush-logs node common/scripts/install-run-rush.js coverage
            mkdir -p coverage
            for p in packages/* ; do [ -d "$p" -a -d "$p/coverage" ] || continue ; pp="$(basename "$p")" ; cp -av "$p/coverage" "coverage/$pp" ; done
      - run:
          name: upload coverage
          command: |
            sudo npm i -g lcov-result-merger codecov
            lcov-result-merger 'packages/*/coverage/lcov.info' 'lcov-merged.out'
            cat "lcov-merged.out" | codecov || true
      - store_artifacts:
          path: coverage
      - store_artifacts:
          path: rush-logs
      - store_artifacts:
          path: /home/circleci/project/reports/junit/
      - store_test_results:
          path: /home/circleci/project/reports/junit/

  pact:
    docker:
      - image: circleci/node:10.15.3
        environment:
          DATABASE_URL: postgres://root:@127.0.0.1:5432/circle_test
          RUSH_ABSOLUTE_SYMLINKS: "true"
      - image: postgres:9
        environment:
          POSTGRES_USER: root
          POSTGRES_DB: circle_test
      - image: singularities/pubsub-emulator
        environment:
          PUBSUB_PROJECT_ID: test
          PUBSUB_LISTEN_ADDRESS: 0.0.0.0:8802
      - image: singularities/datastore-emulator
        environment:
          DATASTORE_PROJECT_ID: test
          DATASTORE_LISTEN_ADDRESS: 0.0.0.0:8803
    steps:
      - attach_workspace:
          at: ./
      - restore_cache:
          keys:
            - rush-global-v1-{{ checksum "common/config/rush/pnpm-lock.yaml" }}
      - run:
          name: Pact Acceptance Tests
          command: |
            repo-tools/scripts/run-rush-collect-logs.sh rush-logs node common/scripts/install-run-rush.js test-ci-pact
      - run:
          name: Coverage
          command: |
            repo-tools/scripts/run-rush-collect-logs.sh rush-logs node common/scripts/install-run-rush.js coverage
            mkdir -p coverage
            for p in packages/* ; do [ -d "$p" -a -d "$p/coverage" ] || continue ; pp="$(basename "$p")" ; cp -av "$p/coverage" "coverage/$pp" ; done
      - run:
          name: upload coverage
          command: |
            sudo npm i -g lcov-result-merger codecov
            lcov-result-merger 'packages/*/coverage/lcov.info' 'lcov-merged.out'
            cat "lcov-merged.out" | codecov || true
      - store_artifacts:
          path: coverage
      - store_artifacts:
          path: rush-logs
      - store_artifacts:
          path: /home/circleci/project/reports/junit/
      - store_test_results:
          path: /home/circleci/project/reports/junit/

  pre-deploy-1:
    docker:
      - image: circleci/node:10.15.3
        environment:
          RUSH_ABSOLUTE_SYMLINKS: "true"
    steps:
      - setup_remote_docker
      - attach_workspace:
          at: ./
      - run:
          name: Build Rush Cache Image Part 1
          command: |
            repo-tools/scripts/create-base-docker-1.sh

  pre-deploy-2:
    docker:
      - image: circleci/node:10.15.3
        environment:
          RUSH_ABSOLUTE_SYMLINKS: "true"
    steps:
      - setup_remote_docker
      - attach_workspace:
          at: ./
      - run:
          name: Build Rush Cache Image Part 2
          command: |
            repo-tools/scripts/create-base-docker-2.sh

  deploy:
    docker:
      - image: circleci/node:10.15.3
        environment:
          RUSH_ABSOLUTE_SYMLINKS: "true"
    steps:
      - setup_remote_docker
      - attach_workspace:
          at: ./
      - restore_cache:
          keys:
            - rush-global-v1-{{ checksum "common/config/rush/pnpm-lock.yaml" }}
      - run:
          name: Set Up Environment
          # have to repeat this step because it stores stuff in ~/.npmrc which isn't cached
          command: |
            ci_scripts/ci_tool.sh --setup_npm
      - run:
          name: Publish
          command: |
            repo-tools/scripts/run-rush-collect-logs.sh rush-logs node common/scripts/install-run-rush.js publish --include-all -r https://sixriver.jfrog.io/sixriver/api/npm/npm-local/ -p --version-policy prerelease
      - run:
          name: Release
          command: |
            repo-tools/scripts/run-rush-collect-logs.sh rush-logs node common/scripts/install-run-rush.js release
      - run:
          name: Publish Pacts
          command: |
            repo-tools/scripts/run-rush-collect-logs.sh rush-logs node common/scripts/install-run-rush.js publish-pacts
      - store_artifacts:
          path: rush-logs

workflows:
  version: 2

  build-deploy:
    jobs:
      - install:
          context: 6rs-circle
      - save_local_cache:
          context: 6rs-circle
          requires:
            - install
      - build:
          context: 6rs-circle
          requires:
            - install
      - lint:
          context: 6rs-circle
          requires:
            - install
      - test:
          context: 6rs-circle
          requires:
            - build
      - pact:
          context: 6rs-circle
          requires:
            - build
      - pre-deploy-1:
          context: 6rs-circle
          requires:
            - install
      - pre-deploy-2:
          context: 6rs-circle
          requires:
            - pre-deploy-1
            - build
      - deploy:
          context: 6rs-circle
          requires:
            - pre-deploy-2
            - lint
            - build
            - test
